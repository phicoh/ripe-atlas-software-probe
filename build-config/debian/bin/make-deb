#!/bin/sh
VERSION=5000-1

set -e

stadir="$PWD/atlasswprobe-$VERSION"
builddir="$PWD/atlasswprobe-$VERSION"-work

srcdir="$PWD/ripe-atlas-software-probe"

atlas_local_rel="usr/local/atlas"
var_atlas_rel="var/atlas-probe"
sta_atlas_local="$stadir/$atlas_local_rel"
sta_var_atlas="$stadir/$var_atlas_rel"

#rm -rf "$stadir" 
mkdir -p "$stadir"
#rm -rf "$builddir"
mkdir -p "$builddir"
cp -r "$srcdir/probe-busybox" "$builddir/probe-busybox"

# Build
(
	cd "$builddir/probe-busybox/libevent-2.0.20-stable"
	./configure
	make
	cd ..
	make
)

# Install
(
	cd "$builddir/probe-busybox"
	make install
	mkdir -p "$sta_atlas_local/bb-13.3"
	cp -r ./_install/* "$sta_atlas_local/bb-13.3"
	mkdir -p "$sta_atlas_local/lib"
	cp ./libevent-2.0.20-stable/.libs/libevent-*so* "$sta_atlas_local/lib"
	cp ./libevent-2.0.20-stable/.libs/libevent_openssl-*so* "$sta_atlas_local/lib"
	mkdir -p "$sta_atlas_local/bin/arch/debian-sw-probe"
	mkdir -p "$sta_atlas_local/bin/arch/linux"
)

(
	cd "$srcdir"
	cp bin/ATLAS "$sta_atlas_local/bin"
	cp bin/common-pre.sh "$sta_atlas_local/bin"
	cp bin/common.sh "$sta_atlas_local/bin"
	cp bin/reginit.sh "$sta_atlas_local/bin"
	cp bin/arch/debian-sw-probe/* "$sta_atlas_local/bin/arch/debian-sw-probe"
	cp bin/arch/linux/* "$sta_atlas_local/bin/arch/linux"
	mkdir -p "$sta_atlas_local/etc"
	cp atlas-config/etc/* "$sta_atlas_local/etc"
	mkdir -p "$sta_atlas_local/state"
	cp atlas-config/state/* "$sta_atlas_local/state"
)

	mkdir -p "$sta_var_atlas/state"
	echo prod > "$sta_var_atlas/state/mode"
	mkdir -p "$sta_var_atlas/bin"

echo 'DEVICE_NAME=debian-sw-probe' > "$sta_var_atlas/bin/config.sh"
echo 'ATLAS_BASE="'"/$var_atlas_rel"'"' >> "$sta_var_atlas/bin/config.sh"
echo 'SUB_ARCH="'"debian-atlasswprobe-$VERSION"'"' >> "$sta_var_atlas/bin/config.sh"

cp -r "$srcdir/build-config/debian/DEBIAN" "$stadir"

fakeroot dpkg-deb --build atlasswprobe-$VERSION
